(function(d,a){typeof exports=="object"&&typeof module<"u"?a(exports,require("nanostores")):typeof define=="function"&&define.amd?define(["exports","nanostores"],a):(d=typeof globalThis<"u"?globalThis:d||self,a(d.nanofetch={},d.nanostores))})(this,function(d,a){"use strict";let R=()=>({events:{},emit(t,...r){let n=this.events[t]||[];for(let s=0,f=n.length;s<f;s++)n[s](...r)},on(t,r){var n;return(n=this.events[t])!=null&&n.push(r)||(this.events[t]=[r]),()=>{var s;this.events[t]=(s=this.events[t])==null?void 0:s.filter(f=>r!==f)}}});const x=({cache:t=new Map,fetcher:r,...n}={})=>{const s=R();let f=!0;N("focus",()=>{f=!0,s.emit(1)}),N("blur",()=>f=!1),N("online",()=>s.emit(2));const i=new Map,h=new Map,S=new Set;let P={};const M=async([e,E],w,c)=>{if(!f)return;const{dedupeTime:v=4e3,fetcher:g}={...c,...P},l=K();t.has(e)||t.set(e,_);const u=o=>{(o!==_||w.get()!==_)&&w.set(o)};b().then(()=>{const o=t.get(e);u(o)}),await b();const m=h.get(e);if(!(m&&m+v>l)&&!S.has(e)){h.set(e,l),S.add(e);try{const o={data:await g(...E),loading:!1};t.set(e,o),u(o),h.set(e,K())}catch(o){w.set({error:o,loading:!1})}finally{S.delete(e)}}};return[(e,{fetcher:E=r,...w}={})=>{if(process.env.NODE_ENV!=="production"&&!E)throw new Error("You need to set up either global fetcher of fetcher in createFetcherStore");const c=a.atom(),v={...n,...w,fetcher:E};let g,l,u,m,o;const F=[];a.onStart(c,()=>{const p=!g;[o,g]=I(e),m=o.listen(D=>{if(D){const[V,L]=D;M([V,L],c,v),l=V,u=L}else l=u=void 0});const O=o.get();O?([l,u]=O,p&&T()):b().then(()=>c.set(_));const{refetchInterval:j=0,refetchOnFocus:z,refetchOnReconnect:U}=v,y=()=>{l&&M([l,u],c,v)};j>0&&i.set(e,setInterval(y,j)),z&&F.push(s.on(1,y)),U&&F.push(s.on(2,y))});const T=()=>{l&&u&&M([l,u],c,v)},q=c.listen;return c.listen=p=>(T(),q(p)),a.onStop(c,()=>{g==null||g(),F.forEach(O=>O()),m();const p=i.get(e);p&&clearInterval(p)}),c},e=>{},e=>{process.env.NODE_ENV!=="test"&&console.warn("You should only use __unsafeOverruleSettings in test environment"),P=e}]},I=t=>{let r=a.atom(null),n=[];const s=()=>{n.some(i=>i===null)?r.set(null):r.set([n.join(""),n])},f=[];for(let i=0;i<t.length;i++){const h=t[i];if(typeof h=="string"){n.push(h);continue}n.push(h.get()),f.push(h.listen(S=>{n[i]=S,s()}))}return s(),[r,()=>f.forEach(i=>i())]},Y=typeof window<"u",N=(t,r)=>{(!Y||process.env.NODE_ENV==="test")&&addEventListener(t,r)},K=()=>new Date().getTime(),b=()=>new Promise(t=>t()),_=Object.freeze({loading:!0});d.nanofetch=x,Object.defineProperties(d,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
