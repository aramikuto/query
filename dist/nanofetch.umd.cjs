(function(a,r){typeof exports=="object"&&typeof module<"u"?r(exports,require("nanostores")):typeof define=="function"&&define.amd?define(["exports","nanostores"],r):(a=typeof globalThis<"u"?globalThis:a||self,r(a.nanofetch={},a.nanostores))})(this,function(a,r){"use strict";const D=({cache:o=new Map,fetcher:S,...s}={})=>{const p=new Set,w=new Set,n=new Map,i=new Map,_=new Set;let T={};const b=async([e,c],l,t)=>{const{dedupeTime:f=4e3,fetcher:v,refetchOnFocus:u,refetchOnReconnect:d,refetchInterval:m}={...t,...T},h=E();u&&p.add(e),d&&w.add(e),m&&!n.has(e)&&n.set(e,window.setInterval(()=>b([e,c],l,t),m));const O=i.get(e);O&&O+f>h||_.has(e)||(i.set(e,h),_.add(e),c||console.log(new Error),v(...c).then(F=>{const g={data:F,loading:!1};o.set(e,g),l.set(g),i.set(e,E())}).catch(F=>l.set({error:F,loading:!1})).finally(()=>_.delete(e)))},K=e=>{!e||(p.delete(e),w.delete(e),clearInterval(n.get(e)))},N=([e,c],l,t)=>{if(!o.has(e)){const f={loading:!0};o.set(e,f)}M(()=>l.set(o.get(e))),b([e,c],l,t)};return[(e,{fetcher:c=S,...l}={})=>{if(process.env.NODE_ENV!=="production"&&!c)throw new Error("You need to set up either global fetcher of fetcher in createFetcherStore");const t=r.atom({loading:!0}),f={...s,...l,fetcher:c};let v,u,d,m,h;r.onStart(t,()=>{const g=!v;[h,v]=U(e),m=h.listen(R=>{if(R){const[V,j]=R;K(u),N([V,j],t,f),u=V,d=j}});const I=h.get();I?([u,d]=I,g&&O()):M(()=>t.set({loading:!0}))});const O=()=>{u&&d&&N([u,d],t,f)},F=t.listen;return t.listen=g=>(O(),F(g)),r.onStop(t,()=>{v(),m(),K(u)}),t},e=>{},e=>{process.env.NODE_ENV!=="test"&&console.warn("You should only use __unsafeOverruleSettings in test environment"),T=e}]},U=o=>{let S=r.atom(null),s=[];const p=()=>{s.some(n=>n===null)?S.set(null):S.set([s.join(""),s])},w=[];for(let n=0;n<o.length;n++){const i=o[n];if(typeof i=="string"){s.push(i);continue}s.push(i.get()),w.push(i.listen(_=>{s[n]=_,p()}))}return p(),[S,()=>w.forEach(n=>n())]},E=()=>new Date().getTime(),M=o=>setTimeout(o);a.nanofetch=D,Object.defineProperties(a,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
